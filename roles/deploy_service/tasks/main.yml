---
- set_fact:
    service_name: "{{ service_dict_obj.key }}"
    service_config: "{{ service_dict_obj.value }}"

- name: Display details about the deployed service
  debug:
    var: "{{ item }}"
  loop:
    - service_name
    - service_config

- name: Create container for the service
  include_role:
    name: create_service_container
  when: service_config['container'] is defined

- name: Publish the service
  when: service_config['publish'] is defined
  block:
    - set_fact:
        service_tls_enabled: "{{ (service_config['publish']['tls']['enabled'] | default(false)) | bool }}"

    - name: Configure SSL certificates for the service
      include_role:
        name: configure_service_tls
        apply:
          delegate_to: "{{ master_host }}"
          become: yes
      when: service_tls_enabled

    - name: Configure HTTP/HTTPS access for the service
      include_role:
        name: configure_service_access
        apply:
          delegate_to: "{{ master_host }}"
          become: yes

    - name: Check whether the service container is active
      include_role:
        name: check_service_status
        apply:
          delegate_to: "{{ master_host }}"

- name: Restart nginx to apply new service config changes
  service:
    name: nginx
    state: restarted
  delegate_to: "{{ master_host }}"
  become: yes
